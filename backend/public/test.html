<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Test Page</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .section {
      margin-bottom: 20px;
      padding: 20px;
      border: 1px solid #eaeaea;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    .hidden {
      display: none;
    }
    .result {
      padding: 15px;
      border-radius: 4px;
    }
    .result.success {
      background-color: #dff0d8;
      border-color: #d6e9c6;
      color: #3c763d;
    }
    .result.error {
      background-color: #f2dede;
      border-color: #ebccd1;
      color: #a94442;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.1);
      border-radius: 50%;
      border-top-color: #0070f3;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .btn {
      padding: 10px 20px;
      background-color: #0070f3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .btn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>API Test Page</h1>
    
    <div class="section">
      <h2>Authentication</h2>
      <button id="authBtn" class="btn">Login with Vercel</button>
      <div id="authStatus" class="result hidden"></div>
    </div>

    <div id="apiSection" class="section hidden">
      <h2>API Endpoints</h2>
      <div>
        <button id="testHelloBtn" class="btn">Test /api/hello</button>
        <button id="testHealthBtn" class="btn">Test /api/health</button>
      </div>
      <div id="apiResult" class="result"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const authBtn = document.getElementById('authBtn');
      const authStatus = document.getElementById('authStatus');
      const apiSection = document.getElementById('apiSection');
      const testHelloBtn = document.getElementById('testHelloBtn');
      const testHealthBtn = document.getElementById('testHealthBtn');
      const apiResult = document.getElementById('apiResult');

      let authToken = localStorage.getItem('vercel_token');
      let tokenExpiry = localStorage.getItem('vercel_token_expiry');

      // Check if token is expired
      if (authToken && tokenExpiry && new Date().getTime() < parseInt(tokenExpiry)) {
        showAuthenticatedUI();
      } else {
        clearAuth();
      }

      // Handle Vercel OAuth callback
      document.addEventListener('DOMContentLoaded', () => {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get('code');
          const error = urlParams.get('error');
          const errorDescription = urlParams.get('error_description');
          
          console.log('OAuth callback received:', { code, error, errorDescription });
          
          if (error) {
            const errorMsg = `OAuth Error: ${error}${errorDescription ? ` - ${errorDescription}` : ''}`;
            console.error(errorMsg);
            showError(authStatus, errorMsg);
          } else if (code) {
            // Show loading state
            showLoading(authStatus, 'Completing authentication...');
            
            // Remove code from URL without page reload
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Process the authorization code
            handleVercelCallback(code);
          }
        } catch (error) {
          console.error('Error in OAuth callback handler:', error);
          showError(authStatus, `Error processing OAuth response: ${error.message}`);
        }
      });

      authBtn.addEventListener('click', startAuth);
      testHelloBtn.addEventListener('click', () => testEndpoint('/api/hello'));
      testHealthBtn.addEventListener('click', () => testEndpoint('/api/health'));

      function startAuth() {
        try {
          // Create a proper redirect URI
          const protocol = window.location.protocol;
          const host = window.location.host;
          const path = '/test.html';
          const redirectUri = `${protocol}//${host}${path}`;
          
          console.log('Initiating OAuth with redirect URI:', redirectUri);
          
          // Create the authorization URL
          const authUrl = new URL('https://vercel.com/oauth/authorize');
          authUrl.searchParams.append('client_id', 'T03NlOIIgkkS7SSIBfFZPUsP');
          authUrl.searchParams.append('redirect_uri', redirectUri);
          authUrl.searchParams.append('state', 'random-state-string');
          authUrl.searchParams.append('scope', 'user:email');
          authUrl.searchParams.append('response_type', 'code');
          
          console.log('Redirecting to:', authUrl.toString());
          window.location.href = authUrl.toString();
        } catch (error) {
          console.error('Error in startAuth:', error);
          showError(authStatus, `Error initializing authentication: ${error.message}`);
        }
      }

      async function handleVercelCallback(code) {
        try {
          showLoading(authStatus, 'Completing authentication with Vercel...');
          
          // Get the current URL without query parameters
          const redirectUri = window.location.origin + window.location.pathname;
          
          console.log('Exchanging code for token...');
          const response = await fetch('/api/auth/vercel', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
              code,
              redirect_uri: redirectUri
            })
          });
          
          const data = await response.json();
          
          if (response.ok && data.token) {
            console.log('Successfully obtained access token');
            
            // Store token and expiry (using expires_in from response or default to 1 hour)
            const expiresIn = data.expires_in || 3600;
            const expiry = new Date().getTime() + (expiresIn * 1000);
            
            localStorage.setItem('vercel_token', data.token);
            localStorage.setItem('vercel_token_expiry', expiry.toString());
            
            // Update UI
            showAuthenticatedUI();
            showSuccess(authStatus, 'Successfully authenticated with Vercel!');
            
            // Clear any error messages
            apiResult.textContent = '';
          } else {
            const errorMsg = data.error || data.details || 'No token received';
            console.error('Token exchange failed:', errorMsg);
            throw new Error(`Authentication failed: ${errorMsg}`);
          }
        } catch (error) {
          console.error('Auth error:', error);
          showError(authStatus, `Authentication failed: ${error.message}`);
          clearAuth();
        }
      }

      function showAuthenticatedUI() {
        authBtn.textContent = 'Logout';
        authBtn.onclick = logout;
        apiSection.classList.remove('hidden');
      }

      function logout() {
        clearAuth();
        window.location.reload();
      }

      function clearAuth() {
        localStorage.removeItem('vercel_token');
        localStorage.removeItem('vercel_token_expiry');
        authBtn.textContent = 'Login with Vercel';
        authBtn.onclick = startAuth;
        apiSection.classList.add('hidden');
        authStatus.classList.add('hidden');
      }

      async function testEndpoint(endpoint) {
        try {
          showLoading(apiResult, `Testing ${endpoint}...`);
          
          const response = await fetch(`/api/proxy${endpoint}`, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('vercel_token')}`
            }
          });
          
          const data = await response.json();
          
          if (response.ok) {
            showSuccess(apiResult, JSON.stringify(data, null, 2));
          } else {
            throw new Error(data.error || `Request failed with status ${response.status}`);
          }
        } catch (error) {
          console.error('API error:', error);
          showError(apiResult, `Error: ${error.message}`);
          
          // Handle unauthorized errors
          if (error.message.includes('401') || error.message.includes('403')) {
            // Clear auth and update UI
            clearAuth();
            showError(authStatus, 'Your session has expired. Please log in again.');
          }
        }
      }

      function showLoading(element, message) {
        element.innerHTML = `<span class="loading"></span>${message}`;
        element.className = 'result';
        element.classList.remove('hidden');
      }

      function showSuccess(element, message) {
        element.textContent = message;
        element.className = 'result success';
      }

      function showError(element, message) {
        element.textContent = message;
        element.className = 'result error';
        element.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
